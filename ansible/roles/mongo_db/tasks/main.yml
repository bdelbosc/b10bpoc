---
# mongod setup
- name: Check if mongod is already setup
  stat: path=/ebs/mongo-log/mongod.log
  register: std

- name: Install mongodb
  apt: state=latest name={{item}} force=yes
  with_items:
  - mongodb-org

- name: Set mongod configuration file
  template: src=mongod.conf.j2 dest=/etc/mongod.conf

- name: Create mongod data dir
  file: path=/ebs/mongod-data state=directory owner=mongodb group=mongodb

- name: Create mongod index dir
  file: path=/ssd/mongod-index state=directory owner=mongodb group=mongodb

- name: Create mongo log dir
  file: path=/ebs/mongo-log state=directory owner=mongodb group=mongodb

- name: Link mongod index dir
  file: path=/ebs/mongod-data/index
        src=/ssd/mongod-index
        state=link
        force=yes

- name: Link mongod log
  file: path=/var/log/mongod.log
        src=/ebs/mongo-log/mongod.log
        state=link
        force=yes

- name: Restart mongod
  service: name=mongod state=restarted
  when: not std.stat.exists

- name: Ensure mongod started
  service: name=mongod state=started
  when: std.stat.exists